#!/usr/bin/env python3
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
#  force_location.py â€” by Dhiru
#  Force Location Services ON for all platforms
#  Works on: Android (Termux) | Kali | Ubuntu | Windows | Any Linux
#
#  NOTE: This runs on the ATTACKER machine or target Android
#  For browser GPS â€” location must be ON in device settings
#  This script enables it via ADB, system commands, or guides
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

import os, sys, subprocess, platform, time

IS_WIN   = sys.platform.startswith('win')
IS_TERMUX= 'com.termux' in os.environ.get('PREFIX','') or 'termux' in os.environ.get('HOME','').lower()

R='\033[91m'; G='\033[92m'; Y='\033[93m'; C='\033[96m'
W='\033[97m'; DIM='\033[2m'; NC='\033[0m'

def banner():
    print(f"\n{C}{'â•'*60}{NC}")
    print(f"{W}  Force Location ON â€” by Dhiru{NC}")
    print(f"{DIM}  Kali | Ubuntu | Termux | Windows | Any Linux{NC}")
    print(f"{C}{'â•'*60}{NC}\n")

def check_root():
    if IS_WIN: return False
    return os.geteuid() == 0

def run(cmd, shell=False):
    try:
        r = subprocess.run(cmd, shell=shell, capture_output=True, text=True, timeout=15)
        return r.returncode == 0, r.stdout.strip(), r.stderr.strip()
    except Exception as e:
        return False, '', str(e)

# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
#  METHOD 1: ADB (Android Debug Bridge)
#  Works when Android phone is connected via USB or
#  running on same network with ADB over WiFi
# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
def force_location_adb():
    print(f"\n{C}[ADB] Trying Android Debug Bridge...{NC}")

    # Check if adb is available
    ok, out, _ = run(['adb', 'version'])
    if not ok:
        print(f"  {Y}ADB not found. Install:{NC}")
        if IS_TERMUX: print(f"  {W}pkg install android-tools{NC}")
        elif IS_WIN:  print(f"  {W}winget install Google.PlatformTools{NC}")
        else:         print(f"  {W}sudo apt install adb{NC}")
        return False

    # Check connected devices
    ok, out, _ = run(['adb', 'devices'])
    if 'device' not in out.replace('List of devices attached',''):
        print(f"  {Y}No Android device connected.{NC}")
        print(f"  Connect phone via USB and enable USB Debugging:")
        print(f"  Settings â†’ Developer Options â†’ USB Debugging â†’ ON")
        return False

    print(f"  {G}âœ“ Android device found{NC}")

    # Enable ALL location modes (GPS + Network + Passive)
    cmds = [
        # Enable GPS provider
        ['adb','shell','settings','put','secure','location_providers_allowed','+gps'],
        # Enable network location
        ['adb','shell','settings','put','secure','location_providers_allowed','+network'],
        # Enable location mode = HIGH_ACCURACY (3)
        ['adb','shell','settings','put','secure','location_mode','3'],
        # For Android 10+
        ['adb','shell','cmd','location','set-location-enabled','true'],
    ]

    for cmd in cmds:
        ok, out, err = run(cmd)
        status = f"{G}âœ“{NC}" if ok else f"{Y}~{NC}"
        print(f"  {status} {' '.join(cmd[2:])}")

    # Verify
    ok, out, _ = run(['adb','shell','settings','get','secure','location_mode'])
    if out.strip() in ['1','2','3']:
        print(f"\n  {G}âœ… Location MODE: {'Network' if out.strip()=='1' else 'Battery Saving' if out.strip()=='2' else 'HIGH ACCURACY'}{NC}")
        return True
    else:
        print(f"\n  {Y}Location mode set â€” please check phone{NC}")
        return True

# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
#  METHOD 2: Linux system (if running on Linux with GUI)
#  Enable location via gsettings / geoclue
# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
def force_location_linux():
    print(f"\n{C}[LINUX] Trying system location settings...{NC}")

    # Method A: gsettings (GNOME)
    ok, out, _ = run(['which','gsettings'])
    if ok:
        cmds = [
            ['gsettings','set','org.gnome.system.location','enabled','true'],
            ['gsettings','set','org.gnome.system.location','max-accuracy-level','exact'],
        ]
        for cmd in cmds:
            ok2, _, _ = run(cmd)
            print(f"  {G+'âœ“' if ok2 else Y+'~'}{NC} {' '.join(cmd[2:])}")

    # Method B: Enable geoclue2 service
    ok, out, _ = run(['systemctl','status','geoclue'], shell=False)
    if ok or 'geoclue' in out.lower():
        run(['systemctl','start','geoclue'])
        run(['systemctl','enable','geoclue'])
        print(f"  {G}âœ“ geoclue2 service started{NC}")

    # Method C: rfkill (unblock GPS if hardware-blocked)
    ok, out, _ = run(['rfkill','list'])
    if ok and 'gps' in out.lower():
        run(['rfkill','unblock','all'])
        print(f"  {G}âœ“ rfkill: unblocked{NC}")

    print(f"  {Y}Note: Browser location still requires user permission in browser{NC}")
    return True

# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
#  METHOD 3: Windows â€” Enable Location Services
# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
def force_location_windows():
    print(f"\n{C}[WINDOWS] Enabling location services...{NC}")

    # Registry method to enable location for apps
    reg_cmds = [
        # Enable location service system-wide
        'reg add "HKEY_LOCAL_MACHINE\\SOFTWARE\\Microsoft\\Windows\\CurrentVersion\\CapabilityAccessManager\\ConsentStore\\location" /v "Value" /t REG_SZ /d "Allow" /f',
        # Enable for current user
        'reg add "HKEY_CURRENT_USER\\SOFTWARE\\Microsoft\\Windows\\CurrentVersion\\CapabilityAccessManager\\ConsentStore\\location" /v "Value" /t REG_SZ /d "Allow" /f',
        # Enable location for apps
        'reg add "HKEY_CURRENT_USER\\SOFTWARE\\Microsoft\\Windows NT\\CurrentVersion\\Sensor\\Permissions\\{BFA794E4-F964-4FDB-90F6-51056BFE4B44}" /v "SensorPermissionState" /t REG_DWORD /d 1 /f',
    ]

    for cmd in reg_cmds:
        ok, out, err = run(cmd, shell=True)
        key_name = cmd.split('"')[1].split('\\')[-1][:40]
        print(f"  {G+'âœ“' if ok else R+'âœ—'}{NC} Registry: {key_name}")

    # PowerShell: Enable location via Settings
    ps_cmd = 'powershell -Command "Set-Location -ErrorAction SilentlyContinue; Add-AppCapability -ErrorAction SilentlyContinue"'
    run(ps_cmd, shell=True)

    # Start Location service
    ok, _, _ = run(['sc','start','lfsvc'], shell=False)
    if ok: print(f"  {G}âœ“ Location service (lfsvc) started{NC}")

    print(f"\n  {Y}Note: You may need to manually allow in Windows Settings:{NC}")
    print(f"  {W}Settings â†’ Privacy & Security â†’ Location â†’ ON{NC}")
    return True

# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
#  METHOD 4: Termux on Android â€” direct settings
# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
def force_location_termux():
    print(f"\n{C}[TERMUX] Enabling Android location...{NC}")

    # termux-location test
    ok, out, _ = run(['termux-location'], shell=False)
    if ok and 'latitude' in out.lower():
        print(f"  {G}âœ… Location already working!{NC}")
        try:
            import json
            loc = json.loads(out)
            print(f"  {G}Lat: {loc.get('latitude','?')}  Lon: {loc.get('longitude','?')}{NC}")
        except: pass
        return True

    # Try to enable via settings put
    cmds = [
        'settings put secure location_mode 3',
        'settings put secure location_providers_allowed +gps',
        'settings put secure location_providers_allowed +network',
    ]
    for cmd in cmds:
        ok, out, err = run(f'am broadcast -a android.location.PROVIDERS_CHANGED 2>/dev/null; {cmd}', shell=True)
        print(f"  {Y}â†’{NC} {cmd}")

    print(f"\n  {Y}If location is still OFF, do this manually:{NC}")
    print(f"  1. Pull down notification panel")
    print(f"  2. Tap the ğŸ“ Location icon to turn ON")
    print(f"  3. Or: Settings â†’ Location â†’ Turn ON")
    print(f"  4. Then run WeatherLive again\n")

    # Try termux-open-url to open settings
    run(['termux-open-url', 'android.settings.LOCATION_SOURCE_SETTINGS'])
    return True

# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
#  METHOD 5: ADB WiFi (remote Android over network)
# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
def force_location_adb_wifi():
    print(f"\n{C}[ADB WiFi] Connect to Android over network{NC}")
    print(f"  Phone pe ye karo:")
    print(f"  1. Settings â†’ Developer Options â†’ Wireless Debugging â†’ ON")
    print(f"  2. 'Pair device with pairing code' tap karo")
    print(f"  3. IP:Port dikhega â€” wahan se connect karo:\n")

    ip = input(f"  {C}Phone ka IP:Port (e.g. 192.168.1.5:37000): {NC}").strip()
    code = input(f"  {C}Pairing code (6 digits): {NC}").strip()

    if ':' in ip:
        h, p = ip.rsplit(':',1)
        ok, out, err = run(['adb','pair',ip,code])
        if ok or 'Successfully' in out:
            print(f"  {G}âœ“ Paired!{NC}")
            run(['adb','connect',ip])
            return force_location_adb()
        else:
            print(f"  {R}Pairing failed: {err}{NC}")
    return False

# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
#  MAIN
# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
def main():
    banner()
    system = platform.system().lower()
    is_root = check_root()

    print(f"  Platform: {W}{platform.system()} {platform.machine()}{NC}")
    print(f"  Root/Admin: {G+'Yes' if is_root else Y+'No (some methods may fail)'}{NC}")
    print(f"  Termux: {G+'Yes' if IS_TERMUX else DIM+'No'}{NC}\n")

    print(f"  {W}Select method:{NC}")
    print(f"  {G}[1]{NC} ADB â€” Connected Android phone via USB")
    print(f"  {G}[2]{NC} ADB WiFi â€” Android phone over network")
    if IS_TERMUX:
        print(f"  {G}[3]{NC} Termux â€” Enable on this Android device")
    elif system == 'linux':
        print(f"  {G}[3]{NC} Linux system location (GNOME/geoclue)")
    elif IS_WIN:
        print(f"  {G}[3]{NC} Windows â€” Enable location services")
    print(f"  {G}[4]{NC} Show manual guide for all platforms")
    print(f"  {G}[5]{NC} Test â€” check if location is working\n")

    try: ch = input(f"{C}Choice: {NC}").strip()
    except (KeyboardInterrupt, EOFError): print("\nBye!"); return

    if ch == '1':
        force_location_adb()
    elif ch == '2':
        force_location_adb_wifi()
    elif ch == '3':
        if IS_TERMUX: force_location_termux()
        elif system == 'linux': force_location_linux()
        elif IS_WIN: force_location_windows()
        else: print(f"{Y}Not available for {system}{NC}")
    elif ch == '4':
        print_manual_guide()
    elif ch == '5':
        test_location()
    else:
        print(f"{Y}Invalid choice{NC}")


def print_manual_guide():
    print(f"""
{W}Manual Guide â€” Turn ON Location:{NC}

{C}Android (Chrome browser):{NC}
  1. Settings â†’ Location â†’ Turn ON
  2. Chrome â†’ address bar lock icon
  3. Site Settings â†’ Location â†’ Allow

{C}iPhone/iPad (Safari):{NC}
  1. Settings â†’ Privacy â†’ Location Services â†’ ON
  2. Settings â†’ Safari â†’ Location â†’ Allow

{C}Windows (Chrome/Edge):{NC}
  1. Windows Settings â†’ Privacy â†’ Location â†’ ON
  2. Browser â†’ lock icon â†’ Location â†’ Allow

{C}Linux (Chrome):{NC}
  1. Chrome â†’ Settings â†’ Privacy â†’ Site Settings â†’ Location â†’ Allow
  2. For GNOME: Settings â†’ Privacy â†’ Location Services â†’ ON

{C}Termux/Android Terminal:{NC}
  1. Pull down notification â†’ tap Location icon
  2. Or: am start -n com.android.settings/.Settings
  3. Or: settings put secure location_mode 3
""")


def test_location():
    print(f"\n{C}[TEST] Checking location status...{NC}")

    if IS_TERMUX:
        ok, out, err = run(['termux-location'])
        if ok and 'latitude' in out.lower():
            print(f"  {G}âœ… Location WORKING!{NC}")
            try:
                import json; loc = json.loads(out)
                print(f"  {G}Lat: {loc.get('latitude','?')}{NC}")
                print(f"  {G}Lon: {loc.get('longitude','?')}{NC}")
                print(f"  {G}Accuracy: {loc.get('accuracy','?')}m{NC}")
            except: print(f"  {G}{out[:100]}{NC}")
        else:
            print(f"  {R}âœ— Location NOT working: {err[:80]}{NC}")
        return

    # ADB check
    ok, out, _ = run(['adb','devices'])
    if ok and 'device' in out:
        ok2, out2, _ = run(['adb','shell','settings','get','secure','location_mode'])
        mode_map = {'0':'OFF','1':'Sensors Only','2':'Battery Saving','3':'HIGH ACCURACY'}
        mode = mode_map.get(out2.strip(), out2.strip())
        col = G if out2.strip() == '3' else (Y if out2.strip() in ['1','2'] else R)
        print(f"  {col}Android Location Mode: {mode}{NC}")

        # Get current GPS coords via ADB
        ok3, out3, _ = run(['adb','shell','dumpsys','location','|','grep','Last Known', '&&', 'echo ok'], shell=True)
        if out3: print(f"  {C}Last GPS: {out3[:80]}{NC}")
    else:
        print(f"  {Y}No ADB device connected{NC}")

    print(f"\n  {DIM}Browser GPS can only be tested by opening the app{NC}")


if __name__ == '__main__':
    main()
